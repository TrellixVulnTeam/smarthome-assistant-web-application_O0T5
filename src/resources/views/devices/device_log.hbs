<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<div class="title" style="margin-bottom: 0px;">Danh s√°ch thi·∫øt b·ªã v√† tr·∫°ng th√°i
</div>
<div class="toolbar-content">
    <div class="button-refresh">
        <button onClick="autoRefresh();"  class="btn btn-primary btn-lg">Refresh Page</button>
    </div>
    
    <div class="receive-tb-container" style="margin-left: 20px;">
        <div class="dropdown">
            <button class="btn btn-primary btn-lg dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            L·ªçc theo
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenu2">
                <button class="dropdown-item" type="button" onclick="FormatByWeek()">Theo tu·∫ßn</button>
                <button class="dropdown-item" type="button" onclick="FormatByMonth()">Theo th√°ng</button>
                <button class="dropdown-item" type="button" onclick="FormatByYear()">Theo nƒÉm</button>
            </div>
        </div>

    </div>

    <div class="receive-tb-container">
        <div class="receive-filter" style="margin-right:-35px;">
            <input id="myInput" type="text" placeholder="T√¨m ki·∫øm...">
        </div>  
    </div>


</div>
<!--
{{#if ret_list}}
<div class="toolbar-content">

    <div class="receive-tb-container">
        <div class="dropdown">
            <button class="btn btn-primary btn-lg dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            L·ªçc theo
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenu2">
                <button class="dropdown-item" type="button" onclick="FormatByWeek()">Theo tu·∫ßn</button>
                <button class="dropdown-item" type="button" onclick="FormatByMonth()">Theo th√°ng</button>
                <button class="dropdown-item" type="button" onclick="FormatByYear()">Theo nƒÉm</button>
            </div>
        </div>

    </div>
   
</div>
{{/if}}
-->
{{#if devices_list}}
<div class="waiting-content">
    <div class="my-table">
        <table class="list">
        <thead>
            <tr>
                {{!-- <th>M√£</th> --}}
                <th>T√™n thi·∫øt b·ªã</th>
                <th class="col-time">Th·ªùi gian t·∫°o thi·∫øt b·ªã</th>
            </tr>
        </thead>
        <tbody id="receive-body">

            {{#each devices_list}}
            
            <tr>
                {{!-- <td>{{this.id}}</td> --}}
                <td>
                    <div class="mycontainer">
                        <a href="/device_status" class="button" style="vertical-align:middle"><span>{{this.device_name}}</span></a>
                    </div>
                    
                    
                </td>
                <td class="col-time">{{formatDate this.create_time}}</td>
                {{!-- {{#each ret_list}} --}}
                <td>
                    {{!-- <a href="/device_status/{{this.id}}" class="btn btn-primary btn-lg">Chi ti·∫øt</a> --}}
                   
                        {{this.value}}
                    
                </td>
                {{!-- {{/each}} --}}
                
            </tr>
            {{/each}}
        </tbody>
    </table>
    <table class="list" id="toSortContent">
        <thead>
            <tr>
                <th>Tr·∫°ng th√°i g·∫ßn ƒë√¢y nh·∫•t</th>
                <th>Th·ªùi gian xu·∫•t hi·ªán tr·∫°ng th√°i</th>
            </tr>
        </thead>
        <tbody id="receive-body" >

            {{#each ret_list}}
            
            <tr>
                
                {{!-- {{#each ret_list}} --}}
                <td>
                    {{!-- <a href="/device_status/{{this.id}}" class="btn btn-primary btn-lg">Chi ti·∫øt</a> --}}
                   
                        {{this.value}}
                    
                </td>
                <td class="col-time">{{formatDate this.created_at}}</td>
                {{!-- {{/each}} --}}
                
            </tr>
            {{/each}}
        </tbody>
    </table>
    </div>
</div>
<br>


{{else}}
<h2 class="note">Hi·ªán t·∫°i ch∆∞a c√≥ th√¥ng tin n√†o ƒë·ªÉ hi·ªÉn th·ªã</h2>
{{/if}}


<script src="/vendor/jquery/jquery-3.6.0.min.js"></script>
<script>
    
    function formatDate(date) {
        if (date) {
            let option = { hour: "2-digit", minute: "2-digit", second: "2-digit" };
            
            return new Date(date).toLocaleDateString("vi-VN", option);
        }
    }
    
    function hideContent(){
        var table, tr, td, i, j;
        table = document.getElementById("toSortContent");
        tr = table.getElementsByTagName("tr");
        for (i = 1; i < tr.length; i++) {
           
                tr[i].style.display = "";
           
        }
    }
    function log_console() {
            console.log(devices_list);
    }
</script>

<script>
    function autoRefresh() {
        window.location = window.location.href;
    }
    alertHighGasvalue();
    
</script>
<script>

    if(sessionStorage.getItem("sort_state")){
        let state = sessionStorage.getItem("sort_state");
        if(state =="1"){
            FormatByWeek();
        }else if(state == "2"){
            FormatByMonth();
        }else if(state == "3"){
            FormatByYear();
        }
    }

    $(document).ready(function () {
        $("#myInput").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $("#receive-body tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
        alertHighGasvalue();
    });
    function autoRefresh() {
        window.location = window.location.href;
    }

    function getTable(){
        var table = document.getElementById("toSortContent");
        return table;
    }

    function FormatByWeek(){
            
            var tableRef = getTable();
            if(tableRef){
                for (var r = 1, n = tableRef.rows.length; r < n; r++) {
                    tr = tableRef.getElementsByTagName("tr");
                    $(tr[r]).show();
                }
                for (var r = 1, n = tableRef.rows.length; r < n; r++) {
                    for (var c = 1, m = tableRef.rows[r].cells.length; c < m; c++) {
                        let tmp = tableRef.rows[r].cells[c].innerHTML;
                        let tmpTime = tmp.split(",");
                        let tmpSlit1 = tmpTime[1].split("/");
                        let dayToCheck = tmpSlit1[0];
                        
        
                        var curr = new Date; // get current date
                        const date = new Date(curr);
                        const day = date.getDay(); // üëâÔ∏è get day of week
                        // Day of month - day of week (-6 if Sunday), otherwise +1
                        const firstDayOfWeek = date.getDate() - day + (day === 0 ? -6 : 1);
                        const lastDayOfWeek = firstDayOfWeek + 6;
                   
                        console.log("first day of week: " + firstDayOfWeek);
                        
                        console.log("last day of week: " + lastDayOfWeek);
                        if(dayToCheck < firstDayOfWeek || dayToCheck > lastDayOfWeek){
                        
                            {{!-- alert("monthToCheck == d.getMonth"); --}}
                            table = document.getElementById("toSortContent");
                            tr = table.getElementsByTagName("tr"); 
                            $(tr[r]).hide();
                        }
                        
                        
                    }
                }
                sessionStorage.setItem("sort_state", "1")
                
            }
        
    }
    function FormatByMonth(){

            var tableRef = getTable();
            if(tableRef){
                for (var r = 1, n = tableRef.rows.length; r < n; r++) {
                    tr = tableRef.getElementsByTagName("tr");
                    $(tr[r]).show();
                }
                for (var r = 1, n = tableRef.rows.length; r < n; r++) {
                    for (var c = 1, m = tableRef.rows[r].cells.length; c < m; c++) {
                        let tmp = tableRef.rows[r].cells[c].innerHTML;
                        let tmpTime = tmp.split(",");
                        let tmpSlit1 = tmpTime[1].split("/");
                        let monthToCheck = tmpSlit1[1];
                        
                        let d = new Date();
                        if(monthToCheck - 1 != d.getMonth()){
                        
                            {{!-- alert("monthToCheck == d.getMonth"); --}}
                            table = document.getElementById("toSortContent");
                            tr = table.getElementsByTagName("tr"); 
                            $(tr[r]).hide();
                        }
                        
                        
                    }
                }
                sessionStorage.setItem("sort_state", "2")
                
            }
        
    }
    
    function FormatByYear(){
            
            var tableRef = getTable();
            if(tableRef){
                for (var r = 1, n = tableRef.rows.length; r < n; r++) {
                    tr = tableRef.getElementsByTagName("tr");
                    $(tr[r]).show();
                }    
                for (var r = 1, n = tableRef.rows.length; r < n; r++) {
                    for (var c = 1, m = tableRef.rows[r].cells.length; c < m; c++) {
                        let tmp = tableRef.rows[r].cells[c].innerHTML;
                        let tmpTime = tmp.split(",");
                        let tmpSlit1 = tmpTime[1].split("/");
                        let yearToCheck = tmpSlit1[2];
                        
                        let d = new Date();
                        if(yearToCheck != d.getFullYear()){
                        
                            {{!-- alert("monthToCheck == d.getMonth"); --}}
                            table = document.getElementById("toSortContent");
                            tr = table.getElementsByTagName("tr"); 
                            $(tr[r]).hide();
                            
                        }
                        
                        
                    }
                }
                sessionStorage.setItem("sort_state", "3")
                
            }
        
    }
    function alertHighGasvalue(){
        $.ajax({
            
            url: '/tester/getLastGasValue',
            
            method: 'GET',
            dataType: 'json',
            success:function(response){ 
                //console.log('msg: '+ response.data);
                if(response.msg=='success'){  
                    
                    
                    //console.log('value: ' + response.data[0].value);
                    
                    if(response.data[0].value > '60'){
                        alert('C·∫¢NH B√ÅO: PH√ÅT HI·ªÜN N·ªíNG ƒê·ªò KH√ç GAS B·∫§T TH∆Ø·ªúNG, XIN VUI L√íNG KI·ªÇM TRA CƒÇN H·ªò C·ª¶A B·∫†N NGAY L·∫¨P T·ª®C!!');
                    }
                    
                    alertHighGasvalue();
                }else{  
                    
                    alert('get last gas data failed :(');  
                }  
            },  
            error:function(response){  
                     alert('server error')     
            }  
        });
    }
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous">
</script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
